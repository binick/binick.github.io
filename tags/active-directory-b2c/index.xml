<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>active directory b2c on a developer&#39;s journey to the cloud</title>
    <link>https://binick.blog/tags/active-directory-b2c/</link>
    <description>Recent content in active directory b2c on a developer&#39;s journey to the cloud</description>
    <generator>Hugo -- gohugo.io</generator>
    <managingEditor>nicola.biancolini@gmail.com (Nicola Biancolini)</managingEditor>
    <webMaster>nicola.biancolini@gmail.com (Nicola Biancolini)</webMaster>
    <copyright>See this site&#39;s source code [here](https://github.com/binick/binick.github.io), licensed under GPLv3.</copyright>
    <lastBuildDate>Sat, 08 Jan 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://binick.blog/tags/active-directory-b2c/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Develop integrated solutions with Active Directory B2C and Azure Event Grid.</title>
      <link>https://binick.blog/2022/01/08/aadb2c-subscribe-to-user-registration-event/</link>
      <pubDate>Sat, 08 Jan 2022 00:00:00 +0000</pubDate>
      <author>nicola.biancolini@gmail.com (Nicola Biancolini)</author>
      <guid>https://binick.blog/2022/01/08/aadb2c-subscribe-to-user-registration-event/</guid>
      <description>Let&amp;#39;s see how you can integrate a user&amp;#39;s registration.</description>
      <content:encoded><![CDATA[<p>We will see how it&rsquo;s possible to create a solution that integrates Azure Active Directory B2C to save on Blob Storage dummy data at user registration.</p>
<h2 id="solution-overview">Solution overview.</h2>
<p>The solution is composed as follows:</p>
<figure class="align-center background-light">
    <img loading="lazy" src="component-map.svg#center"
         alt="Solution composition"/> <figcaption>
            <p>Solution composition</p>
        </figcaption>
</figure>

<ul>
<li><code>read-customer-details-identity-la</code>: represents the API whose purpose is to retrieve the content of the <em>blob</em> from <code>customersstgacc</code> (the <em>storage account</em>)</li>
<li><code>customer-register-tpc</code>: is the <em>topic</em> in which are collected the events of the creation of a new user</li>
<li><code>customer-identity-details-filler-la</code>: it represents the API that is in charge of generating fictitious data that will be saved inside a <em>blob</em> on the <code>customersstgacc</code>
<figure class="align-center ">
    <img loading="lazy" src="logic-app-steps.png#center"
         alt="Logic app definition"/> 
</figure>
</li>
<li><code>contoso-b2c</code>: is the access and identity management service offered by <em>Azure</em></li>
</ul>
<h2 id="introduction-to-_azure-event-grid_">Introduction to <em>Azure Event Grid</em>.</h2>
<p>In <em>Azure</em> there is an implementation of the <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">publish/subscribe</a> pattern designed to facilitate integration and resource management via an event-driven development paradigm.</p>
<p>Through the <em>Event Grid</em> will be possible to subscribe to <a href="https://docs.microsoft.com/azure/event-grid/overview#event-sources">built-in message sources</a> via a <a href="https://docs.microsoft.com/azure/event-grid/overview#event-handlers">set of handlers</a>.</p>
<p>If this is not enough, it is possible to create custom _topics to which you can subscribe to receive events.</p>
<h2 id="creating-a-custom-_topic_">Creating a custom <em>topic</em>.</h2>
<p>You can refer to <a href="https://docs.microsoft.com/azure/event-grid/custom-event-quickstart-portal#create-a-custom-topic">this guide</a> to create a <em>topic</em>.</p>
<p>One choice to make when creating the <em>topic</em> concerns the scheme of the <em>HTTP</em> request content used. Currently, supported schemas are:</p>
<ul>
<li><a href="https://docs.microsoft.com/azure/event-grid/event-schema"><code>Event Grid Schema</code></a></li>
<li><a href="https://docs.microsoft.com/azure/event-grid/cloud-event-schema"><code>Cloud Event Schema</code></a></li>
<li><code>Custom Input Schema</code> this schema will require the creation of an <a href="https://docs.microsoft.com/azure/event-grid/input-mappings">association</a> between the properties of the input object and those required by the <code>Event Grid Schema</code></li>
</ul>
<p>The message used in this case has the following structure</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="ln" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1"> 1</a></span><span class="p">[</span>
<span class="ln" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2"> 2</a></span>    <span class="p">{</span>
<span class="ln" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3"> 3</a></span>        <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="p">{</span>
<span class="ln" id="4"><a style="outline: none; text-decoration:none; color:inherit" href="#4"> 4</a></span>            <span class="nt">&#34;objectId&#34;</span><span class="p">:</span> <span class="s2">&#34;25100647-****-4571-****-b03e4ce72d02&#34;</span> <span class="c1">// unique user identifier
</span><span class="ln" id="5"><a style="outline: none; text-decoration:none; color:inherit" href="#5"> 5</a></span><span class="c1"></span>        <span class="p">},</span>
<span class="ln" id="6"><a style="outline: none; text-decoration:none; color:inherit" href="#6"> 6</a></span>        <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;25100647-****-4571-****-b03e4ce72d02&#34;</span><span class="p">,</span> <span class="c1">// unique message identifier, the same of `data.objectId` in this case
</span><span class="ln" id="7"><a style="outline: none; text-decoration:none; color:inherit" href="#7"> 7</a></span><span class="c1"></span>        <span class="nt">&#34;eventType&#34;</span><span class="p">:</span> <span class="s2">&#34;Microsoft.ActiveDirectory&#34;</span><span class="p">,</span> 
<span class="ln" id="8"><a style="outline: none; text-decoration:none; color:inherit" href="#8"> 8</a></span>        <span class="nt">&#34;subject&#34;</span><span class="p">:</span> <span class="s2">&#34;*.onmicrosoft.com&#34;</span><span class="p">,</span>
<span class="ln" id="9"><a style="outline: none; text-decoration:none; color:inherit" href="#9"> 9</a></span>        <span class="nt">&#34;dataVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;1.0&#34;</span><span class="p">,</span>
<span class="ln" id="10"><a style="outline: none; text-decoration:none; color:inherit" href="#10">10</a></span>        <span class="nt">&#34;metadataVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
<span class="ln" id="11"><a style="outline: none; text-decoration:none; color:inherit" href="#11">11</a></span>        <span class="nt">&#34;eventTime&#34;</span><span class="p">:</span> <span class="s2">&#34;2021-12-03T21:04:03.8504745Z&#34;</span><span class="p">,</span>
<span class="ln" id="12"><a style="outline: none; text-decoration:none; color:inherit" href="#12">12</a></span>        <span class="nt">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;/subscriptions/{your-subscription-id}/resourceGroups/{your-resource-group}/providers/Microsoft.EventGrid/topics/{your-event-grid-topic}&#34;</span>
<span class="ln" id="13"><a style="outline: none; text-decoration:none; color:inherit" href="#13">13</a></span>    <span class="p">}</span>
<span class="ln" id="14"><a style="outline: none; text-decoration:none; color:inherit" href="#14">14</a></span><span class="p">]</span>
</code></pre></div><h2 id="issuing-the-registration-event">Issuing the registration event.</h2>
<p>Sending events to the <em>topic</em> is done using a <a href="https://docs.microsoft.com/azure/active-directory-b2c/restful-technical-profile"><code>RESTful technical profile</code></a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="ln" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1"> 1</a></span><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">&#34;AAD-UserEmitRegistrationEvent&#34;</span><span class="nt">&gt;</span>
<span class="ln" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2"> 2</a></span>    <span class="nt">&lt;DisplayName&gt;</span>Emit user registration event to Event Grid.<span class="nt">&lt;/DisplayName&gt;</span>
<span class="ln" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3"> 3</a></span>    <span class="nt">&lt;Protocol</span> <span class="na">Name=</span><span class="s">&#34;Proprietary&#34;</span> <span class="na">Handler=</span><span class="s">&#34;Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&#34;</span> <span class="nt">/&gt;</span>
<span class="ln" id="4"><a style="outline: none; text-decoration:none; color:inherit" href="#4"> 4</a></span>    <span class="nt">&lt;Metadata&gt;</span>
<span class="ln" id="5"><a style="outline: none; text-decoration:none; color:inherit" href="#5"> 5</a></span>        <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">&#34;ServiceUrl&#34;</span><span class="nt">&gt;</span>{Settings:CustomerRegisteredTopicUrl}<span class="nt">&lt;/Item&gt;</span>
<span class="ln" id="6"><a style="outline: none; text-decoration:none; color:inherit" href="#6"> 6</a></span>        <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">&#34;AuthenticationType&#34;</span><span class="nt">&gt;</span>ApiKeyHeader<span class="nt">&lt;/Item&gt;</span>
<span class="ln" id="7"><a style="outline: none; text-decoration:none; color:inherit" href="#7"> 7</a></span>        <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">&#34;SendClaimsIn&#34;</span><span class="nt">&gt;</span>Body<span class="nt">&lt;/Item&gt;</span>
<span class="ln" id="8"><a style="outline: none; text-decoration:none; color:inherit" href="#8"> 8</a></span>        <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">&#34;ClaimUsedForRequestPayload&#34;</span><span class="nt">&gt;</span>userRegisterEvent<span class="nt">&lt;/Item&gt;</span>
<span class="ln" id="9"><a style="outline: none; text-decoration:none; color:inherit" href="#9"> 9</a></span>        <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">&#34;DefaultUserMessageIfRequestFailed&#34;</span><span class="nt">&gt;</span>Cannot process your request right now, please try again later.<span class="nt">&lt;/Item&gt;</span>
<span class="ln" id="10"><a style="outline: none; text-decoration:none; color:inherit" href="#10">10</a></span>    <span class="nt">&lt;/Metadata&gt;</span>
<span class="ln" id="11"><a style="outline: none; text-decoration:none; color:inherit" href="#11">11</a></span>    <span class="nt">&lt;CryptographicKeys&gt;</span>
<span class="ln" id="12"><a style="outline: none; text-decoration:none; color:inherit" href="#12">12</a></span>        <span class="nt">&lt;Key</span> <span class="na">Id=</span><span class="s">&#34;aeg-sas-key&#34;</span> <span class="na">StorageReferenceId=</span><span class="s">&#34;B2C_1A_CustomerRegisteredTopicSas&#34;</span> <span class="nt">/&gt;</span>
<span class="ln" id="13"><a style="outline: none; text-decoration:none; color:inherit" href="#13">13</a></span>    <span class="nt">&lt;/CryptographicKeys&gt;</span>
<span class="ln" id="14"><a style="outline: none; text-decoration:none; color:inherit" href="#14">14</a></span>    <span class="nt">&lt;InputClaimsTransformations&gt;</span>
<span class="ln" id="15"><a style="outline: none; text-decoration:none; color:inherit" href="#15">15</a></span>        <span class="nt">&lt;InputClaimsTransformation</span> <span class="na">ReferenceId=</span><span class="s">&#34;GetSystemDateTime&#34;</span> <span class="nt">/&gt;</span>
<span class="ln" id="16"><a style="outline: none; text-decoration:none; color:inherit" href="#16">16</a></span>        <span class="nt">&lt;InputClaimsTransformation</span> <span class="na">ReferenceId=</span><span class="s">&#34;GenerateRegistrationEventRequest&#34;</span> <span class="nt">/&gt;</span>
<span class="ln" id="17"><a style="outline: none; text-decoration:none; color:inherit" href="#17">17</a></span>    <span class="nt">&lt;/InputClaimsTransformations&gt;</span>
<span class="ln" id="18"><a style="outline: none; text-decoration:none; color:inherit" href="#18">18</a></span>    <span class="nt">&lt;InputClaims&gt;</span>
<span class="ln" id="19"><a style="outline: none; text-decoration:none; color:inherit" href="#19">19</a></span>        <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">&#34;userRegisterEvent&#34;</span> <span class="nt">/&gt;</span>
<span class="ln" id="20"><a style="outline: none; text-decoration:none; color:inherit" href="#20">20</a></span>    <span class="nt">&lt;/InputClaims&gt;</span>
<span class="ln" id="21"><a style="outline: none; text-decoration:none; color:inherit" href="#21">21</a></span>    <span class="nt">&lt;PersistedClaims&gt;</span>
<span class="ln" id="22"><a style="outline: none; text-decoration:none; color:inherit" href="#22">22</a></span>        <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">&#34;systemDateTime&#34;</span> <span class="nt">/&gt;</span>
<span class="ln" id="23"><a style="outline: none; text-decoration:none; color:inherit" href="#23">23</a></span>    <span class="nt">&lt;/PersistedClaims&gt;</span>
<span class="ln" id="24"><a style="outline: none; text-decoration:none; color:inherit" href="#24">24</a></span>    <span class="nt">&lt;UseTechnicalProfileForSessionManagement</span> <span class="na">ReferenceId=</span><span class="s">&#34;SM-AAD&#34;</span> <span class="nt">/&gt;</span>
<span class="ln" id="25"><a style="outline: none; text-decoration:none; color:inherit" href="#25">25</a></span><span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div><p>This fragment of markup translated into <code>curl</code> command, for more explicability, would look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="ln" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a></span>curl -X POST -H <span class="s2">&#34;aeg-sas-key: </span><span class="nv">$key</span><span class="s2">&#34;</span> -d <span class="s2">&#34;</span><span class="nv">$event</span><span class="s2">&#34;</span> <span class="nv">$endpoint</span>
</code></pre></div><p>where the authentication requirements are met by the <code>AuthenticationType</code> metadata to which is associated the cryptographic key <code>aeg-sas-key</code> whose value is retrieved from the key <code>B2C_1A_CustomerRegisteredTopicSas</code> present in the collection of <a href="https://docs.microsoft.com/azure/active-directory-b2c/policy-keys-overview?pivots=b2c-custom-policy">policy keys</a>.</p>


<p><details >
  <summary markdown="span">TL;DR</summary>
  <blockquote>
<p>The choice of the <em>topic</em> template in this example was guided by the limitations currently imposed by the <a href="https://docs.microsoft.com/azure/active-directory-b2c/restful-technical-profile"><em>RESTful</em> technical profile</a> regarding the possibilities of building the <em>HTTP</em> request, in fact for a combination of criteria it is not possible to pass information in the headers and the body of the request at the same time.<br>
This makes it impossible to send towards a <em>topic</em> schemes of type <code>Cloud Event</code> since the protocol, in version <em>1.0</em> requires the presence of a <a href="https://docs.microsoft.com/azure/event-grid/cloud-event-schema#sample-event-using-cloudevents-schema">mandatory header</a>.</p>
</blockquote>

</details></p>

<p>Much more complex is the creation of the body of the request for which it is necessary:</p>
<ul>
<li>use the <a href="https://docs.microsoft.com/azure/active-directory-b2c/technicalprofiles#input-claims-transformations"><code>InputClaimsTransformation</code></a></li>
<li>add two statements inside the baggage <code>userRegisterEvent</code> and <code>systemDateTime</code> both of type <em>string</em>.</li>
</ul>
<p>Finally, the <em>technical profile</em> has been added among the <em>technical validation profiles</em> of <a href="https://github.com/binick/samples/blob/7782bd6bfcfcb8c2b18dc911d501b29ec05f8212/src/enrich-a-jwt-token-with-ief/ief/TrustFrameworkBase.xml#L764"><code>LocalAccountSignUpWithLogonEmail</code></a> so that the event is issued only when a user is registered.</p>
<h3 id="using-claim-transformations">Using claim transformations.</h3>
<p>During the creation of <em>custom criteria</em> we could have the necessity to execute calculations, as the number of attempts of authentication, that even if very simple would result impossible without the execution of functions.</p>
<p>This requirement finds expressivity through the <code>ClaimsTransformation</code> whose <a href="https://docs.microsoft.com/azure/active-directory-b2c/claimstransformations#claims-transformations-reference">reference of the transformations of the claims</a> contains the complete list of the <em>transformations</em> usable.</p>
<p>In the example the methods <a href="https://docs.microsoft.com/azure/active-directory-b2c/date-transformations#getcurrentdatetime"><code>GetCurrentDateTime</code></a> and <a href="https://docs.microsoft.com/azure/active-directory-b2c/json-transformations#generatejson"><code>GenerateJson</code></a> were used</p>
<p>`` xml
<ClaimsTransformation Id="GetSystemDateTime" TransformationMethod="GetCurrentDateTime">
<OutputClaims>
<OutputClaim ClaimTypeReferenceId="systemDateTime" TransformationClaimType="currentDateTime" />
</OutputClaims>
</ClaimsTransformation></p>
<pre tabindex="0"><code>
The purpose of `GetSystemDateTime` is to enhance the `systemDateTime` claim.

`` xml
&lt;ClaimsTransformation Id=&quot;GenerateRegistrationEventRequest&quot; TransformationMethod=&quot;GenerateJson&quot;&gt;
    &lt;InputClaims&gt;
        &lt;InputClaim ClaimTypeReferenceId=&quot;objectId&quot; TransformationClaimType=&quot;0.data.objectId&quot; /&gt;
        &lt;InputClaim ClaimTypeReferenceId=&quot;objectId&quot; TransformationClaimType=&quot;0.id&quot; /&gt;
        &lt;InputClaim ClaimTypeReferenceId=&quot;systemDateTime&quot; TransformationClaimType=&quot;0.eventTime&quot; /&gt;
    &lt;/InputClaims&gt;
    &lt;InputParameters&gt;
        &lt;InputParameter Id=&quot;0.dataVersion&quot; DataType=&quot;string&quot; Value=&quot;1.0&quot; /&gt;
        &lt;InputParameter Id=&quot;0.eventType&quot; DataType=&quot;string&quot; Value=&quot;Microsoft.ActiveDirectory&quot; /&gt;
        &lt;InputParameter Id=&quot;0.subject&quot; DataType=&quot;string&quot; Value=&quot;{Settings:Tenant}&quot; /&gt;
    &lt;/InputParameters&gt;
    &lt;OutputClaims&gt;
        &lt;OutputClaim ClaimTypeReferenceId=&quot;userRegisterEvent&quot; TransformationClaimType=&quot;outputClaim&quot; /&gt;
    &lt;/OutputClaims&gt;
&lt;/ClaimsTransformation&gt;
</code></pre><p><code>GenerateRegistrationEventRequest</code> has instead the burden of constructing the JSON and enhancing the <code>userRegisterEvent</code> claim.</p>
<h2 id="conclusions">Conclusions.</h2>
<p>In this article, we have seen how through <em>Identity Experience Framework</em> it is possible to integrate a B2C tenant with our infrastructure and open possible interesting development scenarios.<br>
To do this we touched on <em>Azure Event Grid</em> and how to create an <em>Event Grid Topic</em>.</p>
<p>Finally how you can <a href="https://docs.microsoft.com/azure/active-directory-b2c/claimstransformations#claims-transformations-reference">manipulate attestations</a> and use them within <a href="https://docs.microsoft.com/azure/active-directory-b2c/technicalprofiles"><em>technical profiles</em></a>.</p>
<p>If you are interested in the complete example you can find it at <a href="https://github.com/binick/samples/tree/master/src/enrich-a-jwt-token-with-ief">https://github.com/binick/samples/tree/master/src/enrich-a-jwt-token-with-ief</a>.</p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
